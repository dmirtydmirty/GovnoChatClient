name: Build-and-test
on: push

env:
  SOURCE_DIR: ${{ github.workspace }}
  QT_VERSION: 6.8.2
  QT_ARCH: "win64_mingw"
  BUILD_TYPE: Debug
  ARTIFACT_WITHOUT_ZIP_ENDING: GovnoChatClient
  BUILD_DIR_NAME: buildGovnoChatClient
  

jobs:
  build-and-test:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Ninja (choco)
        uses: actions/checkout@v3
        run: choco install ninja
        shell: powershell

      - name: Add Ninja to PATH
        shell: pwsh
        run: |
          $ninjaPath = Get-Command ninja | Select-Object -ExpandProperty Definition | Split-Path
          Write-Host "Adding Ninja to PATH: $ninjaPath"
          $env:PATH += ";$ninjaPath"
          Write-Host "PATH: $($env:PATH)"

      - name: Install Qt
        id: install-qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: "windows"
          target: desktop
          arch: ${{ env.QT_ARCH }}
          cache: true

      - name: Set up environment variables
        shell: pwsh
        run: |
          $qtDir = "${{ steps.install-qt.outputs.install-dir }}/${{ steps.install-qt.outputs.qt-version }}/${{ env.QT_VERSION }}/bin"
          Write-Host "Adding Qt bin directory to PATH: $qtDir"
          $env:PATH += ";$qtDir"
          Write-Host "PATH: $($env:PATH)"

      - name: Configure CMake
        run: |
          cmake -G "Ninja" -B ${{ runner.temp }}\${{ env.BUILD_DIR_NAME }} -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DCMAKE_PREFIX_PATH="$env:QtDir"

      - name: Build
        run: |
          cd build
          ninja
          
